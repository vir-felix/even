{% layout "_LayoutCheckout" %}
{% global active_menu="PaymentInfo" step_index="1" %}
<form action="{% route api_CheckoutPayment %}" method="post" id="form-payment-info">
    {% control xsrf %}
    <div class="container">
        <div class="row">
            <div class="col-8 offset-2">
                {% if error %}
                <div class="alert alert-danger">
                    {{"An error occurred while processing payment. Please try a different payment method" | t}}
                </div>
                {% endif %}
            </div>
            <div class="col-8 offset-2">
                <h3>
                    {{"Payment Info" | t}}
                </h3>
                {% if paymentMethods.size > 0 %}
                <select name="SystemName" class="form-control" id="PaymentMethodSystemName">
                    {% for paymentMethod in paymentMethods %}
                    <option value="{{paymentMethod.systemName}}">
                        {{paymentMethod.friendlyName}}
                    </option>
                    {% endfor %}
                </select>
                {% endif %}
                <div id="payment-info-form">

                </div>
            </div>
        </div>
        <div class="text-center">
            <input type="hidden" name="orderGuid" value="{{orderGuid}}" />
            <input type="submit" class="btn btn-default" value='{{"Next" | t}}' />
        </div>
    </div>
</form>
<script type="text/javascript">
    ready(function () {
        var paymentMethods = [];
        //{% for paymentMethod in paymentMethods %}
        paymentMethods["{{paymentMethod.systemName}}"] = "{{paymentMethod.url}}";
        //{% endfor %}
        initAjaxForm("form-payment-info",
            {
                onSuccess: function (response) {
                    var confirmInfoUrl = "{% route CheckoutConfirm %}";
                    window.location.href = confirmInfoUrl;
                },
                onError: function() {

                }
            });
        jQuery("#PaymentMethodSystemName").change(function() {
            var method = jQuery(this).val();
            var url = paymentMethods[method];
            get({
                url: url,
                done: function (response) {
                    jQuery("#payment-info-form").html(response);
                }
            });
        });
        jQuery("#PaymentMethodSystemName").trigger("change");
    });
</script>